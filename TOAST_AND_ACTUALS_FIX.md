# Toast Notifications & Job Actuals Fix Summary

## Issues Addressed

### 1. ✅ Multiple Toast Notifications During Job Import
**Problem:** During bulk job import in Settings, multiple toast notifications were appearing for each job update, cluttering the UI.

**Solution:** Implemented a single persistent toast that updates its message throughout the import process:
- Created one toast at the start of import with `progressToast`
- Used `progressToast.update()` to update the same toast every 10 jobs
- Shows real-time progress: "Processing X of Y jobs... (N created, M updated, P skipped, Q errors)"
- Final message confirms completion with summary

**Code Location:** `src/pages/Settings.tsx` lines 248-545

### 2. ✅ Actual Costs Calculation During Import
**Problem:** User was concerned that actual costs weren't showing in Job Costing table after running the bulk import with "Update existing jobs" checked.

**How It Works:**
The bulk import in Settings.tsx already calculates actual costs from Odoo's `account.analytic.line` entries:

1. **During Import (for each job):**
   - Fetches all analytic account IDs (sale order + project if different)
   - Queries `account.analytic.line` with negative amounts (expenses/costs)
   - Categorizes lines as material vs non-material using keyword matching
   - Stores calculated actuals in `jobs` table:
     - `material_actual`
     - `non_material_actual`
     - `total_actual`

2. **After Import:**
   - Query cache is invalidated: `queryClient.invalidateQueries({ queryKey: ['jobs'] })`
   - Job Costing page automatically refetches and displays updated actuals

**Code Location:** 
- Calculation logic: `src/pages/Settings.tsx` lines 154-225 (`calculateJobActuals` function)
- Applied during import: lines 455-479

### 3. ℹ️ Console Errors - Browser Extension Issue
**Errors Seen:**
```
Unchecked runtime.lastError: A listener indicated an asynchronous response by returning true, 
but the message channel closed before a response was received
```

**Explanation:**
These errors are **NOT** caused by the application code. They are generated by browser extensions (commonly Chrome extensions) that interact with web pages. Common culprits include:
- Password managers
- Ad blockers
- Security extensions
- Developer tools extensions

**Why They Occur:**
Browser extensions use message passing APIs, and sometimes they set up listeners that expect async responses but don't handle the connection closing properly.

**Impact:**
⚠️ These errors do NOT affect application functionality. They are safe to ignore.

**If You Want to Eliminate Them:**
1. Try disabling browser extensions one by one to identify the culprit
2. Test in Incognito mode (extensions disabled by default)
3. Test in a different browser

## Testing the Fixes

### Test Case 1: Single Persistent Toast
1. Go to Settings page
2. Check "Update existing jobs" checkbox
3. Click "Import All Jobs from Odoo"
4. **Expected:** One toast appears and updates its message throughout the process
5. **Previous Behavior:** Multiple toasts would appear, one for each job processed

### Test Case 2: Actual Costs Displayed
1. Complete the bulk import from Settings (with or without update mode)
2. Wait for "Import Complete" message
3. Navigate to Job Costing page
4. **Expected:** Jobs show actual costs in the "Actual" column
5. **Calculation:** Actuals are calculated from analytic line entries during import
6. Click on a specific job to see detailed breakdown of actual costs

### Test Case 3: Updated Jobs Show New Actuals
1. Run import with "Update existing jobs" checked
2. Wait for completion
3. Navigate to Job Costing
4. **Expected:** Existing jobs show recalculated actual costs based on latest analytic line data
5. Jobs table shows updated `total_actual`, `material_actual`, and `non_material_actual`

## Key Features

### Progress Toast Updates
The toast now shows detailed progress:
- "Import Started" → "Processing Jobs" → "Importing Jobs (X/Y)" → "Import Complete"
- Real-time counters: created, updated, skipped, errors
- Final summary includes confirmation that actuals were calculated

### Actual Cost Calculation Details

#### Material vs Non-Material Classification:
**Non-Material Keywords (priority):**
- LABOUR, LABOR, FREIGHT, CRANAGE, CRANE
- EQUIPMENT, PLANT HIRE, INSTALLATION
- SILICON, SEALANT, SERVICE, HIRE
- TRAVEL, ACCOMMODATION

**Material Keywords:**
- RAW, HEX BOLT, WASHER, NUT GAL, SCREW
- BRACKET, FIXING, STANDARD LADDER, WALKWAY
- M10, M12, M16, BOLT, HARDWARE
- STUB COLUMN, POWDER COATING, GALVANIS
- POST, RHS, SHS, CHS, STEEL, ALUMINIUM
- PLATE, ANGLE, CHANNEL, BEAM

#### Data Sources:
1. **Primary:** Sale Order analytic account (`analytic_account_id`)
2. **Secondary:** Project analytic account (`project_analytic_account_id`) if different
3. Both accounts are queried for complete cost picture

## Files Modified

### `src/pages/Settings.tsx`
- **Lines 248-253:** Create persistent toast
- **Lines 293-296:** Update toast with initial progress
- **Lines 312-317:** Update toast every 10 jobs with counters
- **Lines 528-532:** Final success message with toast update
- **Lines 541-545:** Error handling with toast update
- **Lines 805-808:** Updated help text to explain actual cost calculation

## Additional Notes

1. **Rate Limiting:** Import includes 150ms delay between jobs to avoid overwhelming Odoo API
2. **Error Handling:** Individual job failures don't stop the entire import
3. **Cache Invalidation:** Jobs query cache is properly invalidated after import completes
4. **Data Persistence:** Calculated actuals are stored in database and persist across sessions
5. **Real-time Updates:** UI updates automatically when navigating to Job Costing page after import

## Verification Steps

After the fix, verify:
- [ ] Only one toast notification during import
- [ ] Toast updates with progress information
- [ ] Import completes successfully
- [ ] Navigate to Job Costing page
- [ ] Jobs show non-zero actual costs (if they have analytic line entries)
- [ ] Job detail page shows breakdown of material vs non-material actuals
- [ ] Budget utilization percentages are calculated correctly

## Browser Console Errors
The `runtime.lastError` messages in the console are **NOT** related to this application. They come from browser extensions and can be safely ignored. They do not impact any functionality of the Con-form Dashboard.

